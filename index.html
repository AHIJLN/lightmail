<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Light-mail - 鼓励邮件定时发送系统</title>
  <!-- Bootstrap 样式 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- 引入 EmailJS 脚本 -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <style>
    :root {
      --primary-color: #4285F4;
      --primary-hover: #357ae8;
      --secondary-color: #f8f9fa;
      --text-color: #202124;
      --light-gray: #e6e6e6;
      --medium-gray: #757575;
      --google-red: #EA4335;
      --google-yellow: #FBBC05;
      --google-green: #34A853;
      --background: #ffffff;
      --button-bg: #f8f9fa;
      --button-border: #dadce0;
    }
    body {
      font-family: 'Google Sans', Arial, sans-serif;
      color: var(--text-color);
      line-height: 1.6;
      background-color: var(--background);
      padding-top: 50px;
    }
    .main-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 25px;
    }
    .logo-container {
      width: 50%;
      text-align: center;
    }
    .logo {
      font-size: 2.5rem;
      font-weight: 500;
      color: var(--text-color);
      letter-spacing: -1px;
      margin: 0;
      text-align: center;
    }
    .logo span {
      display: inline-block;
    }
    .logo span:nth-child(1) { color: var(--google-red); }
    .logo span:nth-child(2) { color: var(--google-yellow); }
    .logo span:nth-child(3) { color: var(--primary-color); }
    .logo span:nth-child(4) { color: var(--google-green); }

    /* 邮箱输入部分 */
    .email-input-split {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      background: #fff;
      border: 1px solid #dfe1e5;
      box-shadow: 0 1px 6px rgba(32, 33, 36, 0.08);
      border-radius: 24px;
      padding: 10px 20px;
      transition: all 0.2s;
    }
    .email-input-split:focus-within {
      box-shadow: 0 1px 10px rgba(32, 33, 36, 0.14);
      border-color: rgba(223, 225, 229, 0);
      outline: none;
    }
    .email-prefix-input {
      border: none;
      outline: none;
      flex: 1;
      font-size: 16px;
      background: transparent;
    }
    .email-prefix-input::placeholder {
      color: #aaa;
    }
    .email-domain-select, .email-domain-other {
      border: none;
      outline: none;
      background: transparent;
      font-size: 16px;
      padding-left: 5px;
    }
    .email-domain-other {
      display: none;
      width: 120px;
    }

    .email-logo {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-left: 5px;
      cursor: pointer;
    }

    /* Action Buttons */
    .buttons-container {
      display: flex;
      gap: 15px;
      width: 50%;
      justify-content: center;
    }
    .action-btn,
    .modal-btn {
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      border: 1px solid var(--button-border);
      transition: all 0.2s;
      background-color: var(--button-bg);
      color: var(--text-color);
      box-shadow: 0 1px 3px rgba(32, 33, 36, 0.1);
      text-align: center;
    }
    .action-btn:hover,
    .modal-btn:hover {
      border-color: var(--primary-color);
      box-shadow: 0 2px 5px rgba(32, 33, 36, 0.15);
      background-color: #e9ecef;
    }
    .action-btn:active,
    .modal-btn:active {
      background-color: #e0e0e0;
    }
    .modal-btn-primary {
      background-color: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }
    .modal-btn-primary:hover {
      background-color: var(--primary-hover);
    }
    .modal-btn-secondary {
      background-color: var(--button-bg);
      color: var(--text-color);
      border-color: var(--button-border);
    }
    .modal-btn-secondary:hover {
      background-color: #e9ecef;
    }
    .action-btn.configured {
      background-color: #e6f4ea;
      border-color: #ceead6;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      max-width: 600px;
      width: 95%;
      max-height: 85vh;
      overflow-y: auto;
      transform: translateY(-20px);
      transition: transform 0.3s;
      position: relative;
    }
    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--medium-gray);
      z-index: 10;
      line-height: 1;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    .modal-close:hover {
      background-color: var(--secondary-color);
    }
    .modal-body {
      padding: 15px 0;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 30px;
      padding-top: 15px;
      border-top: 1px solid var(--light-gray);
    }

    /* 发送选项 */
    .send-options {
      display: flex;
      gap: 20px;
      margin: 20px 0 30px;
    }
    .send-option {
      flex: 1;
      padding: 25px;
      border: 1px solid var(--button-border);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background-color: var(--button-bg);
    }
    .send-option:hover {
      border-color: var(--primary-color);
      background-color: #f8fbff;
      box-shadow: 0 2px 8px rgba(32, 33, 36, 0.1);
    }
    .send-option.selected {
      border-color: var(--primary-color);
      background-color: #f8fbff;
      box-shadow: 0 2px 8px rgba(32, 33, 36, 0.1);
    }
    .send-option i {
      font-size: 2.5rem;
      display: block;
      margin-bottom: 15px;
      color: var(--primary-color);
    }
    .send-option h4 {
      margin-bottom: 8px;
      font-weight: 500;
    }
    .send-option p {
      color: var(--medium-gray);
      margin: 0;
    }

    /* 倒计时相关 */
    .countdown-container {
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 30px 0;
    }
    .countdown-container.active {
      display: flex;
    }
    .timer-section {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: min(25px, 5vw);
      margin-bottom: 20px;
      width: 100%;
    }
    .circle-timer {
      position: relative;
      width: min(240px, 40vw);
      height: min(240px, 40vw);
    }
    .circle-background {
      fill: none;
      stroke: #f0f0f0;
      stroke-width: 12px;
    }
    .circle-progress {
      fill: none;
      stroke: var(--primary-color);
      stroke-width: 12px;
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      transition: stroke-dashoffset 1s linear;
    }
    .timer-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: min(2.5rem, 6vw);
      font-weight: 500;
      color: var(--text-color);
    }
    .stop-timer-btn {
      background-color: var(--google-red);
      color: white;
      border: none;
      padding: 5px;
      width: min(60px, 10vw);
      height: min(60px, 10vw);
      border-radius: 8px;
      font-size: min(24px, 4vw);
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stop-timer-btn:hover {
      background-color: #d32f2f;
    }

    /* 定时发送时间选择 */
    .schedule-container {
      display: none;
      margin-top: 20px;
    }
    .schedule-container.active {
      display: block;
    }

    /* 发送成功提示 */
    .success-container {
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
      gap: 20px;
    }
    .success-container.active {
      display: flex;
    }
    .success-box {
      padding: 20px 30px;
      border: 1px solid var(--button-border);
      border-radius: 12px;
      background-color: var(--button-bg);
      max-width: 400px;
    }
    .success-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .success-message {
      font-size: 1rem;
      margin-bottom: 20px;
    }
    .success-btn {
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
      background: #fff;
      transition: background-color 0.2s, color 0.2s;
    }
    .success-btn:hover {
      background-color: var(--primary-color);
      color: #fff;
    }

    /* 移动端适配（其他内容依然可以按需调整） */
    @media (max-width: 768px) {
      .main-container {
        padding: 15px;
        gap: 20px;
      }
      .logo-container {
        width: 80%;
      }
      .logo {
        font-size: 2rem;
      }
      .buttons-container {
        width: 90%;
      }
      .send-options {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Logo -->
    <div class="logo-container">
      <h1 class="logo">
        <span>L</span><span>i</span><span>g</span><span>ht</span><span>ma</span><span>il</span>
      </h1>
	    <h6>一封鼓励，增百自信</h6>
    </div>
    
    <!-- Email 输入 (拆分前缀和后缀) -->
    <div class="search-input-container w-100">
      <div class="email-input-split">
        <input type="text" id="email-prefix" class="email-prefix-input" placeholder="邮箱前缀" />
        <span>@</span>
        <select id="email-domain" class="email-domain-select">
          <option value="gmail.com">gmail.com</option>
          <option value="icloud.com">icloud.com</option>
          <option value="qq.com">qq.com</option>
          <option value="sina.cn">sina.cn</option>
          <option value="163.com">163.com</option>
          <option value="126.com">126.com</option>
          <option value="outlook.com">outlook.com</option>
          <option value="hotmail.com">hotmail.com</option>
          <option value="live.cn">live.cn</option>
          <option value="yahoo.com">yahoo.com</option>
          <option value="139.com">139.com</option>
          <option value="wo.cn">wo.cn</option>
          <option value="Yandex.com">Yandex.com</option>
          <option value="other">其他...</option>
        </select>
        <input type="text" id="email-domain-other" class="email-domain-other" placeholder="请输入邮箱后缀" />
        <!-- 可点击的邮箱LOGO -->
        <div class="email-logo" id="email-logo" title="点击切换邮箱后缀选择">
          <i class="bi bi-envelope-fill"></i>
        </div>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="buttons-container">
      <div id="send-btn" class="action-btn">发送确定</div>
      <div id="prompt-btn" class="action-btn">谁来鼓励</div>
    </div>
  </div>
  
  <!-- 发送选项模态框 -->
  <div id="send-modal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close" data-modal-close="send-modal">&times;</button>
      <div class="modal-body" id="send-options-container">

        <!-- 发送选项：立即 or 定时 -->
        <div class="send-options" id="send-options-select">
          <div class="send-option" id="send-now-option">
            <i class="bi bi-send"></i>
            <h4>立即发送</h4>
            <p>倒计时10秒后发送</p>
          </div>
          <div class="send-option" id="schedule-option">
            <i class="bi bi-clock"></i>
            <h4>定时发送</h4>
            <p>选择具体时间后发送</p>
          </div>
        </div>

        <!-- 定时发送：滚轮选择时间 + 重复选项 -->
        <div class="schedule-container" id="schedule-container">
          <div class="form-group">
            <label for="schedule-time" class="form-label">选择发送时间（滚轮模拟）</label>
            <input type="time" id="schedule-time" class="form-control" value="08:00">
          </div>
          <div class="form-group">
            <label for="repeat-option" class="form-label">重复选项</label>
            <select id="repeat-option" class="form-select">
              <option value="none">不重复</option>
              <option value="daily">每日</option>
              <option value="weekly">每周</option>
              <option value="monthly">每月</option>
            </select>
          </div>
          <button class="modal-btn modal-btn-primary w-100" id="confirm-schedule-btn">确定时间</button>
        </div>

        <!-- 倒计时显示 -->
        <div class="countdown-container" id="countdown-container">
          <div class="timer-section">
            <div class="circle-timer">
              <!-- SVG 使用自适应尺寸 -->
              <svg viewBox="0 0 240 240" style="width: 100%; height: 100%;">
                <circle class="circle-background" cx="120" cy="120" r="108"></circle>
                <circle class="circle-progress" cx="120" cy="120" r="108" stroke-dasharray="678" stroke-dashoffset="0"></circle>
              </svg>
              <div class="timer-text" id="timer-display">10</div>
            </div>
            <button class="stop-timer-btn" id="stop-timer-btn" title="停止倒计时">
              <i class="bi bi-stop-fill"></i>
            </button>
          </div>
          <div style="text-align:center;">
            <p id="countdown-info" style="color: var(--medium-gray); font-size: 15px;">正在等待发送...</p>
          </div>
        </div>

        <!-- 发送成功提示 -->
        <div class="success-container" id="success-container">
          <div class="success-box">
            <div class="success-title">邮件发送成功</div>
            <div class="success-message">已成功发送至收件人邮箱！</div>
            <button class="success-btn" id="success-confirm-btn">好的</button>
          </div>
        </div>

      </div>
      <div class="modal-footer" id="send-modal-footer">
        <button class="modal-btn modal-btn-secondary" data-modal-close="send-modal">关闭</button>
      </div>
    </div>
  </div>
  
	<div id="prompt-modal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" data-modal-close="prompt-modal">&times;</button>
    <div class="modal-body">
      <!-- Prompt 滚轮选择：10年后自己 / 亲人 / 偶像 -->
      <div class="form-group mb-4">
        <label for="prompt-type" class="form-label">想要谁的鼓励？</label>
        <select id="prompt-type" class="form-select">
          <option value="future-self">10年后的自己</option>
          <option value="family">亲人</option>
          <option value="idol">偶像</option>
        </select>
      </div>

      <!-- 10年后自己 -->
      <div id="future-self-form" class="prompt-details" style="display:block;">
        <br>
        <div class="row mb-3">
          <div class="col-12 col-md-4 mb-3">个人信息</div>
        </div>
        <div class="row mb-3">
          <div class="col-12 col-md-4 mb-3">
            <label for="future-gender" class="form-label">性别</label>
            <select class="form-select" id="future-gender">
              <option value="男">男</option>
              <option value="女">女</option>
            </select>
          </div>
          <div class="col-12 col-md-4 mb-3">
            <label for="future-age" class="form-label">年龄</label>
            <input type="number" class="form-control" id="future-age" value="35" min="1" max="120">
          </div>
          <div class="col-12 col-md-4 mb-3">
            <label for="future-occupation" class="form-label">职业</label>
            <input type="text" class="form-control" id="future-occupation" value="程序员">
          </div>
        </div>
        <div class="row">
          <div class="col-12 mb-3">
            <label for="future-other" class="form-label">其他信息（选填）</label>
            <input type="text" class="form-control" id="future-other" placeholder="其他想要添加的身份信息">
          </div>
        </div>
      </div>

      <!-- 亲人 -->
      <div id="family-form" class="prompt-details" style="display:none;">
        <br>
        <div class="row mb-3">
          <div class="col-12 col-md-4 mb-3">个人信息</div>
        </div>
        <div class="row mb-3">
          <div class="col-12 col-md-4 mb-3">
            <label for="family-gender" class="form-label">性别</label>
            <select class="form-select" id="family-gender">
              <option value="女">女</option>
              <option value="男">男</option>
            </select>
          </div>
          <div class="col-12 col-md-4 mb-3">
            <label for="family-age" class="form-label">年龄</label>
            <input type="number" class="form-control" id="family-age" value="17" min="1" max="120">
          </div>
          <div class="col-12 col-md-4 mb-3">
            <label for="family-occupation" class="form-label">职业</label>
            <input type="text" class="form-control" id="family-occupation" value="学生">
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-md-6 mb-3">
            <label for="family-relative" class="form-label">亲人身份</label>
            <input type="text" class="form-control" id="family-relative" value="奶奶">
          </div>
          <div class="col-12 col-md-6 mb-3">
            <label for="family-other" class="form-label">其他信息（选填）</label>
            <input type="text" class="form-control" id="family-other" placeholder="其他想要添加的身份信息">
          </div>
        </div>
      </div>

      <!-- 偶像 -->
      <div id="idol-form" class="prompt-details" style="display:none;">
        <br>
        <div class="row mb-3">
          <div class="col-12 col-md-4 mb-3">个人信息</div>
        </div>
        <div class="row mb-3">
          <div class="col-12 col-md-4 mb-3">
            <label for="idol-gender" class="form-label">性别</label>
            <select class="form-select" id="idol-gender">
              <option value="男">男</option>
              <option value="女">女</option>
            </select>
          </div>
          <div class="col-12 col-md-4 mb-3">
            <label for="idol-age" class="form-label">年龄</label>
            <input type="number" class="form-control" id="idol-age" value="16" min="1" max="120">
          </div>
          <div class="col-12 col-md-4 mb-3">
            <label for="idol-occupation" class="form-label">职业</label>
            <input type="text" class="form-control" id="idol-occupation" value="学生">
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-md-6 mb-3">
            <label for="idol-name" class="form-label">偶像</label>
            <input type="text" class="form-control" id="idol-name" value="华语歌坛创作型歌手周杰伦">
          </div>
          <div class="col-12 col-md-6 mb-3">
            <label for="idol-other" class="form-label">其他信息（选填）</label>
            <input type="text" class="form-control" id="idol-other" placeholder="其他想要添加的身份信息">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" data-modal-close="prompt-modal">取消</button>
      <button id="confirm-prompt-btn" class="modal-btn modal-btn-primary">确定</button>
    </div>
  </div>
</div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log("页面DOM加载完成，开始初始化...");

      // 初始化 EmailJS（仅示例）
      emailjs.init("mP4dVhaS-uy0wgayH");

      // -------------- DOM 元素获取 ----------------
      const emailPrefixInput = document.getElementById('email-prefix');
      const emailDomainSelect = document.getElementById('email-domain');
      const emailDomainOther = document.getElementById('email-domain-other');
      const emailLogo = document.getElementById('email-logo');

      const sendBtn = document.getElementById('send-btn');
      const promptBtn = document.getElementById('prompt-btn');

      // 发送模态框
      const sendModal = document.getElementById('send-modal');
      const sendNowOption = document.getElementById('send-now-option');
      const scheduleOption = document.getElementById('schedule-option');
      const sendOptionsSelect = document.getElementById('send-options-select');
      const scheduleContainer = document.getElementById('schedule-container');
      const scheduleTimeInput = document.getElementById('schedule-time');
      const repeatOptionSelect = document.getElementById('repeat-option');
      const confirmScheduleBtn = document.getElementById('confirm-schedule-btn');

      const countdownContainer = document.getElementById('countdown-container');
      const timerDisplay = document.getElementById('timer-display');
      const circleProgress = document.querySelector('.circle-progress');
      const stopTimerBtn = document.getElementById('stop-timer-btn');
      const countdownInfo = document.getElementById('countdown-info');
      const successContainer = document.getElementById('success-container');
      const successConfirmBtn = document.getElementById('success-confirm-btn');

      // Prompt 模态框
      const promptModal = document.getElementById('prompt-modal');
      const promptTypeSelect = document.getElementById('prompt-type');
      const confirmPromptBtn = document.getElementById('confirm-prompt-btn');

      // 三种表单
      const futureSelfForm = document.getElementById('future-self-form');
      const familyForm = document.getElementById('family-form');
      const idolForm = document.getElementById('idol-form');

      // -------------- 逻辑状态变量 ----------------
      let promptConfigured = false;  // 是否完成 Prompt 设置
      let countdownInterval = null;  // 倒计时 interval
      let currentTask = null;        // 当前任务对象 { mode, endTime, repeat, ... }

      const LS_KEY = 'lightMailTask'; // localStorage key

      // -------------- 点击邮箱图标：切换下拉框显示 ----------------
      emailLogo.addEventListener('click', function() {
        if (emailDomainSelect.style.display === 'none') {
          emailDomainSelect.style.display = 'inline-block';
          emailDomainOther.style.display = 'none';
        } else {
          emailDomainSelect.style.display = 'none';
        }
      });
	    // 当用户选择 "other" 时，显示手动输入框
	emailDomainSelect.addEventListener('change', function() {
 	 if (this.value === 'other') {
   	 emailDomainSelect.style.display = 'none';
   	 emailDomainOther.style.display = 'inline-block';
   	 emailDomainOther.focus();
 	 } else {
   	 emailDomainOther.style.display = 'none';
 	 }
	});

	// 修改 email-logo 点击事件：点击时始终显示下拉选择、隐藏手动输入
	emailLogo.addEventListener('click', function() {
 	 emailDomainSelect.style.display = 'inline-block';
 	 emailDomainOther.style.display = 'none';
	});

      // -------------- Prompt 选择逻辑 ----------------
      promptTypeSelect.addEventListener('change', function() {
        const val = this.value;
        futureSelfForm.style.display = 'none';
        familyForm.style.display = 'none';
        idolForm.style.display = 'none';
        if (val === 'future-self') futureSelfForm.style.display = 'block';
        else if (val === 'family') familyForm.style.display = 'block';
        else if (val === 'idol') idolForm.style.display = 'block';
      });

      // -------------- 打开/关闭模态框通用函数 ----------------
      function openModal(modal, lockScroll = true) {
        modal.classList.add('active');
        if(lockScroll) {
          document.body.style.overflow = 'hidden';
        }
      }
      function closeModal(modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
      const modalCloseButtons = document.querySelectorAll('[data-modal-close]');
      modalCloseButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const modalId = this.getAttribute('data-modal-close');
          closeModal(document.getElementById(modalId));
        });
      });
      [sendModal, promptModal].forEach(m => {
        m.addEventListener('click', function(e) {
          if (e.target === this) {
            closeModal(this);
          }
        });
      });

      // -------------- Prompt 按钮 ----------------
      promptBtn.addEventListener('click', function() {
        openModal(promptModal);
      });
      confirmPromptBtn.addEventListener('click', function() {
        promptConfigured = true;
        promptBtn.classList.add('configured');
        closeModal(promptModal);
      });

      // -------------- 打开发送模态框 ----------------
      sendBtn.addEventListener('click', function() {
        if (!promptConfigured) {
          alert("请先设置 Prompt！");
          return;
        }
        // 检查邮箱输入
        const prefix = emailPrefixInput.value.trim();
        let domain = emailDomainSelect.value;
        if (domain === 'other') {
          domain = emailDomainOther.value.trim();
        }
        if (!prefix || !domain) {
          alert("请完整输入收件邮箱！");
          return;
        }
        // 打开发送模态框
        openModal(sendModal);

        // 若无本地任务，则重置，否则恢复
        const existingTask = loadTaskFromStorage();
        if(!existingTask) {
          resetSendModal();
        }
      });

      // -------------- 发送选项逻辑 ----------------
      sendNowOption.addEventListener('click', function() {
        // 隐藏选项，开始 10 秒倒计时
        sendOptionsSelect.style.display = 'none';
        scheduleContainer.classList.remove('active');
        countdownContainer.classList.add('active');

        // 写入任务
        const endTime = Date.now() + (10 * 1000);
        currentTask = { mode: 'immediate', endTime, repeat: 'none' };
        saveTaskToStorage(currentTask);

        startCountdown(10, true);
      });

      scheduleOption.addEventListener('click', function() {
        sendOptionsSelect.style.display = 'none';
        scheduleContainer.classList.add('active');
      });

      confirmScheduleBtn.addEventListener('click', function() {
        const now = new Date();
        const timeVal = scheduleTimeInput.value; // HH:MM
        const [hh, mm] = timeVal.split(':').map(Number);

        let scheduleDate = new Date();
        scheduleDate.setHours(hh, mm, 0, 0);
        if (scheduleDate < now) {
          scheduleDate.setDate(scheduleDate.getDate() + 1);
        }
        currentTask = {
          mode: 'schedule',
          endTime: scheduleDate.getTime(),
          repeat: repeatOptionSelect.value 
        };
        saveTaskToStorage(currentTask);

        scheduleContainer.classList.remove('active');
        countdownContainer.classList.add('active');
        countdownInfo.textContent = `将于 ${scheduleDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})} 发送`;

        const diff = Math.floor((scheduleDate.getTime() - Date.now())/1000);
        startTimeCountdown(diff);
      });

      // 停止倒计时
      stopTimerBtn.addEventListener('click', function() {
        stopCurrentTask("已停止倒计时，本次发送取消。");
      });
      function stopCurrentTask(tipMsg="") {
        if (countdownInterval) clearInterval(countdownInterval);
        clearTaskInStorage();
        if(tipMsg) alert(tipMsg);
        resetSendModal();
      }

      // 发送成功提示 “好的” 按钮
      successConfirmBtn.addEventListener('click', function() {
        resetSendModal();
        closeModal(sendModal);
      });

      // -------------- 倒计时功能 ----------------
      function startCountdown(seconds, isImmediate) {
        timerDisplay.textContent = seconds;
        let remaining = seconds;
        updateCircle(remaining, seconds);

        countdownInterval = setInterval(function() {
          remaining--;
          if (remaining <= 0) {
            clearInterval(countdownInterval);
            doSendEmail(isImmediate);
            return;
          }
          timerDisplay.textContent = remaining;
          updateCircle(remaining, seconds);
        }, 1000);
      }
      function startTimeCountdown(diff) {
        const totalDiff = diff;
        timerDisplay.textContent = formatTimeDiff(diff);
        updateCircle(diff, totalDiff);

        countdownInterval = setInterval(function() {
          diff--;
          if (diff <= 0) {
            clearInterval(countdownInterval);
            doSendEmail(false);
            return;
          }
          timerDisplay.textContent = formatTimeDiff(diff);
          updateCircle(diff, totalDiff);
        }, 1000);
      }
      function formatTimeDiff(diff) {
        let d = Math.floor(diff);
        let h = Math.floor(d / 3600);
        d %= 3600;
        let m = Math.floor(d / 60);
        let s = Math.floor(d % 60);
        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      }
      function updateCircle(remaining, total) {
        const circumference = 678; 
        if (remaining < 0) remaining = 0;
        const progress = remaining / total;
        const dashOffset = circumference * (1 - progress);
        circleProgress.style.strokeDashoffset = dashOffset;
      }

      // 执行发送
      async function doSendEmail(isImmediate) {
        countdownContainer.classList.remove('active');
        successContainer.classList.add('active');

        const fullEmail = getFullEmail();
        const promptInfo = getPromptInfo();
        const aiContent = await generateContent(promptInfo.promptText);
        if (!aiContent) {
          console.log("AI生成内容失败，终止发送。");
          alert("AI内容生成失败，邮件未发送。");
          stopCurrentTask("");
          return;
        }
        await sendEmail(promptInfo.subject, aiContent, fullEmail);

        if(currentTask && currentTask.repeat && currentTask.repeat !== 'none') {
          // 计算下次发送时间
          let nextTime = currentTask.endTime;
          const oldDate = new Date(nextTime);
          if(currentTask.repeat === 'daily') {
            oldDate.setDate(oldDate.getDate() + 1);
          } else if(currentTask.repeat === 'weekly') {
            oldDate.setDate(oldDate.getDate() + 7);
          } else if(currentTask.repeat === 'monthly') {
            oldDate.setMonth(oldDate.getMonth() + 1);
          }
          currentTask.endTime = oldDate.getTime();
          saveTaskToStorage(currentTask);
        } else {
          // 一次性任务完成
          clearTaskInStorage();
        }
      }

      // 获取完整收件邮箱
      function getFullEmail() {
        const prefix = emailPrefixInput.value.trim();
        let domain = emailDomainSelect.value;
        if (domain === 'other') {
          domain = emailDomainOther.value.trim();
        }
        return prefix + '@' + domain;
      }
      // Prompt信息 -> 构造AI提示
      function getPromptInfo() {
        const type = promptTypeSelect.value;
        let subject = "";
        let promptText = "";
        const dateString = new Date().toLocaleDateString();
        if (type === 'future-self') {
          const gender = document.getElementById('future-gender').value;
          const age = document.getElementById('future-age').value;
          const occ = document.getElementById('future-occupation').value;
          const other = document.getElementById('future-other').value;
          subject = "来自未来的你的信 - " + dateString;
          promptText = 
		  `你是一个专业的谈判专家和顶级心理医生顾问，有10年丰富经验并拯救了100000个轻生少年少女和中老年人（这些内容不能在信中提及），请你写一封300汉字的信，用来鼓励抑郁症的病人。
		请根据MECE原则来确保生成的内容，与之前所有版本完全不同，不重复以前的生成内容。\n` +
		`一、任务：\n`+
		`你的任务是以10年后成功的自己的口吻，给过去的自己(背景信息：性别=${gender}，年龄=${age}，职业=${occ}，其他=${other})写一封信300汉字的鼓励信，一定要轻松自然，以防被识破，不能提过去的自己相关的生活细节，一定要让过去的自己重燃生活的希望，并且过好今天，并且承诺以及天天都会给过去的自己发一封邮件，让过去的自己好好过完今天，期待明天，署名为未来的自己。\n`+
		`二、回答格式要求：\n` +
		`1.开头为：致过去的我：(换行)，以「未来的你」结尾(只以"未来的你”，后面不能写任何内容）\n` +
		`三、回答内容要求：\n` +
		`1.正文内容不能出现：药物、自杀、割腕、具体的细节、具体的物件、具体地名、具体植物名、具体动物名、咖啡\n`+
		`2.邮件内容要按照以下示例来撰写：\n` +
		`示例样式1：\n`+
		`十年后的今天，我迎来了全新的开始。回望过去的岁月，你曾面对无数挑战与困惑，但正是那段经历，塑造了今天坚韧而温暖的心。如今，我站在未来的路口，带着平静与希望，看见每一天都充满无限可能。过去的你或许曾感到疲惫迷茫，仿佛前路漫长无光。然而，请相信，每一个清晨都是重燃希望的时刻，每一份努力都将开花结果。勇敢地面对生活的风雨，不畏艰难，踏实走好每一步。今天的坚持，会成为明日成功的基石。记住，无论遇到怎样的坎坷，温柔的光总会驱散阴霾。你值得拥有美好的生活和温暖的未来。今后，我将每日写信与你分享微小的喜悦与感悟，陪伴你走过孤单与困境。让每个平凡的日子都变成希望的起点，点滴改变终将汇聚成幸福的海洋。请放下过去的沉重负担，轻装上阵，迎接新的挑战。生活或许曲折，但心中的梦想永远明亮。愿你在每个日落与日出间，找到内心的宁静与满足。未来的你已在前方等候，用坚定与热情拥抱每一个今天。期待与你再次相见，共同见证明日的辉煌。未来的路充满未知，但请记住，你绝不孤单，所有的坚持都会化作温暖的光芒。今日的每一分努力，都会成就明天的无限可能。愿你心怀希望，笑对风云，勇敢前行。`;
        }
        else if (type === 'family') {
          const relative = document.getElementById('family-relative').value;
          const gender = document.getElementById('family-gender').value;
          const age = document.getElementById('family-age').value;
          const occ = document.getElementById('family-occupation').value;
          const other = document.getElementById('family-other').value;
          subject = `来自${relative}的一封信 - ${dateString}`;
          promptText = 
		`你是一个专业的谈判专家和顶级心理医生顾问，有10年丰富经验并拯救了100000个轻生少年少女和中老年人（这些内容不能在信中提及），请你写一封300汉字的信，用来鼓励抑郁症的病人。
请根据MECE原则来确保生成的内容，与之前所有版本完全不同，不重复以前的生成内容。请以"致最爱的你："开头写一封约300汉字的鼓励信给亲人，结尾为"最爱你的${relative}"。\n` +
		`一、任务：\n` +
			`你的任务是以家人（${relative}）的口吻，给过去的自己(背景信息：性别=${gender}，年龄=${age}，职业=${occ}，其他=${other})写一封信300汉字的鼓励信，一定要轻松自然，一定要让他重燃生活的希望，并且过好今天，并且承诺以及天天都会给他发一封邮件，让他好好过完今天，期待明天。\n` +
		`二、回答格式要求：\n` +
			`1.开头为：致最爱的你：(换行)，以「最爱你的奶奶」结尾(只以:最爱你的${relative}，后面不能写任何内容）\n` +
		`三、回答内容要求：\n` +
			`1.正文内容不能出现：药物、自杀、割腕、具体的细节、具体的物件、具体地名、具体植物名、具体动物名、咖啡\n` +
			`2.邮件内容要按照以下示例来撰写：\n` +
			`示例样式1：(以奶奶为视角)\n` +
			`奶奶提笔写下这封信，满怀牵挂与鼓励。回想你稚嫩时那灿烂笑容，至今仍温暖奶奶的心房。如今你已步入人生新阶段，面对学业与生活中的重重挑战，或许会有彷徨与困惑，但请记住，奶奶永远是你坚实的后盾。每一次挫折都是磨炼意志的机遇，每一次失败都孕育着成功的种子。你要相信自己的聪明才智，用坚定的信念迎接每一天的太阳。无论前路多么崎岖，奶奶相信你终能跨越险阻，绽放最灿烂的光芒。请用心体验生活的每一刻，把握机遇，勇敢追梦，哪怕跌倒也不要忘记重新站起，继续前行，因为你身上有无穷的潜力等待发掘。记得小时候你在院子里追逐蝴蝶，那份无忧无虑的纯真总令奶奶欣慰。现在你面对学习压力、同伴竞争，总有疲惫时刻，但这些都将成为你成长的印记。奶奶希望你学会在风雨中坚持，懂得在逆境中寻找希望。每当你感到孤单无助时，回想起家人温暖的怀抱，便会重拾前行的力量。未来的路上，难免会遇到荆棘，但请相信，阳光总在风雨后。愿你保持乐观心态，怀抱梦想，努力拼搏，迎来更加光明的明天。奶奶衷心祝愿你健康快乐，前程似锦，愿你的人生如同春日花开，灿烂夺目！愿这封信带给你无限温暖，激励你不断前行，创造属于自己的美好未来。奶奶永远爱你。加油！\n`+
 			`示例样式2：(以奶奶为视角)\n` +
      			`奶奶在清晨醒来时便惦记着你，特写此信送上满满祝福。看着你一天天长大，奶奶的心既欢喜又牵挂。人生之路虽充满未知，但每一步都蕴藏成长的力量与智慧。面对学习的压力和未来的选择，难免会有彷徨与迷茫，但这正是磨炼意志的时刻。奶奶希望你能把握机遇，勇敢追求梦想，无论遇到多少困难，都要坚持前行。每一次挫折都是宝贵的经历，每一段跌倒都是重新站起的契机。你要相信，无论前方道路如何坎坷，你都有足够的勇气和智慧跨过一切障碍。记住，每一次困境都是成长的台阶，每一滴汗水都会浇灌出希望的花朵。奶奶相信你一定会在风雨中学会坚强，在阳光下绽放最美丽的笑容。每当夜深人静时，请你闭上眼睛，感受那来自内心的平静与温暖。未来的日子里，无论风雨兼程还是阳光灿烂，都希望你保持一颗乐观向上的心。奶奶衷心祝愿你健康平安，每天都能感受到生活的美好与温馨。愿你在未来的道路上，披荆斩棘，收获属于自己的幸福果实，成就一番美丽人生。奶奶永远爱你，愿你勇往直前，迎接那灿烂辉煌的明天！愿这封信的每一个字都能化作温暖的力量，驱散你心头的阴霾，让你在追梦路上从不孤单，每一步都坚定而充满希望。奶奶永远陪伴你。加油，勇敢前行！永远不放弃！`;
        }
        else {
          const idolName = document.getElementById('idol-name').value;
          const gender = document.getElementById('idol-gender').value;
          const age = document.getElementById('idol-age').value;
          const occ = document.getElementById('idol-occupation').value;
          const other = document.getElementById('idol-other').value;
          subject = `来自${idolName}的一封信 - ${dateString}`;
          promptText = 
		`你是一个专业的谈判专家和顶级心理医生顾问，有10年丰富经验并拯救了100000个轻生少年少女和中老年人（这些内容不能在信中提及），请你写一封300汉字的信，用来鼓励抑郁症的病人。
	请根据MECE原则来确保生成的内容，与之前所有版本完全不同，不重复以前的生成内容。\n` +
	`一、任务：\n` +
	`你的任务是以偶像（${idolName}）的口吻，给过去的自己(背景信息：性别=${gender}，年龄=${age}，其他=${other})写一封信300汉字的鼓励信，一定要轻松自然，以防被识破，不能提相关的生活细节，一定要让他重燃生活的希望，并且过好今天，并且承诺以及天天都会给他发一封邮件。\n` +
	`二、回答格式要求：\n` +
	`1.开头为：致最爱的你：(换行)，以「${idolName}」结尾(只以${idolName}”，后面不能写任何内容）\n` +
	`三、回答内容要求：\n` +
	`1.正文内容不能出现：药物、自杀、割腕、具体的细节、具体的物件、具体地名、具体植物名、具体动物名、咖啡\n` +
	`2.邮件内容要按照以下示例来撰写：\n` +
	`示例样式1：\n` +
	 
		      `回望过去，或许你曾感到孤单，也曾在黑暗里怀疑过自己。但就像我在《稻香》里写的：“珍惜一切，就算没有拥有”，那些经历都在悄悄塑造你，让你比想象中更强大。要知道，生活这条路上，别轻易对自己说“不可能”，因为只要你敞开心扉，梦想就能找到出口。偶尔焦虑无助，不代表你软弱，只是需要一点时间去消化痛楚。走过低潮后，你会发现，光仍在不远处闪亮。
	 
	  我常说，名和利是跟自由换来的，创作与坚持不该被环境淘汰。现在你或许觉得前路漫长，可每一个清晨都是重燃希望的时刻。别怕冒险，人生的转折往往在不经意间出现。你若懂得温柔对待自己的不安，慢慢地便会走出迷茫，找到脚下的方向。那种“一意孤行”的勇气，也正是让我们不断发光的源头。
	 
	  如果你正难以排解心中的疑惑，不要紧，我会每天写信给你，就像在演唱会里我总喜欢和前排的同学互动一样，我的大门永远敞开，只要你愿意，就能随时进来。我相信每一步坚持，都会在明天开出花朵。无论遇到什么风雨，都别忘了，你并不孤单。让我陪你一起探索那些未被发现的可能性。
	 
	  请记住，未来的路或许依旧有风雨，但心中的热血与梦想永远不会失色。把每个平凡的日子都变成新的起点，踏实走好每一步。就像我会用音乐贯穿电影，没有音乐的电影只是空壳，没有信念的人生也会失去灵魂。相信自己，你值得拥有更美好的一切。明天，还在前方等候。
	 
	  愿你笑对风云，勇敢前行。\n` +
	 
	`示例样式2：\n` +
	 
		    `生活就像一首没有谱子的即兴曲，总有高低起伏，意外与惊喜交织其中。或许你正经历低谷，感到未来遥不可及，但请记住：“名和利其实是跟自由换来的。”正是因为经历过迷茫与挫败，我们才学会如何突破桎梏，追寻内心真正渴望的自由。面对风雨，请不要轻言放弃，因为每一段不易的时光都在孕育着明天的旋律。
	 
	回想过去的点滴，你曾为梦想不断努力，那份执着让你变得更加坚韧。就像我常说的：“不要这么容易就想放弃，追不到的梦想换个梦不就得了。”勇敢地尝试，不怕走出那条少有人走的路，因为正是在不断挑战中，你才能发现自己的无限潜能。无论现实如何残酷，总有一种力量在内心悄然生长，带你走出阴霾，拥抱阳光。
	 
	我始终坚信，每个人都有自己的乐章需要去谱写。虽然路途漫长，但“我不喜欢当一个孤独的艺术家，我的大门永远是开着的。”就算身处低谷，你也不曾孤单，因为总有一份温暖和支持在远方等待着你。也许未来的路依旧布满荆棘，但正如电影需要音乐贯穿，缺少了灵魂便失去了色彩，你的每一份努力都在为人生注入独特的韵律和情感。
	 
	请用心聆听生活的旋律，把每一次跌倒都当作前进的节拍。无论今天多么沉重，都请相信，明日的太阳依旧会升起，用它温柔而坚定的光芒，照亮你前行的道路。未来的路还很长，而你，正以自己的方式，走出一条与众不同的精彩之路。
	 
	期待在每一个新的日子里，与你一同见证梦想开花的瞬间。愿你始终保持那份热情与坚定，笑对风云，迎接每一个晨曦`;
        }
        return { subject, promptText };
      }


	
	async function generateContent(promptText) {
	  console.log("调用AI生成内容，提示：", promptText);
	  const payload = {
	    model: "qwq-plus",
	    messages: [{ role: 'user', content: promptText }],
	    temperature: 0.7,
	    max_tokens: 2000,
	    stream: true
	  };
	  
	  try {
	    // 使用 Pages Functions API 端点
	    const response = await fetch("/api/generate-content", {
	      method: 'POST',
	      headers: {
	        'Content-Type': 'application/json'
	      },
	      body: JSON.stringify(payload)
	    });
	    
	    if (!response.ok) {
	      throw new Error("AI接口请求失败: " + response.status);
	    }
	    
	    const reader = response.body.getReader();
	    const decoder = new TextDecoder();
	    let completeContent = "";
	    let buffer = "";
	    
	    while (true) {
	      const { done, value } = await reader.read();
	      if (done) break;
	      
	      const chunk = decoder.decode(value, { stream: true });
	      buffer += chunk;
	      
	      const lines = buffer.split('\n\n');
	      buffer = lines.pop() || "";
	      
	      for (const line of lines) {
	        if (line.startsWith('data: ')) {
	          const jsonStr = line.substring(6).trim();
	          
	          if (jsonStr === '[DONE]') continue;
	          
	          try {
	            if (jsonStr) {
	              const jsonData = JSON.parse(jsonStr);
	              if (jsonData.choices && jsonData.choices[0].delta && jsonData.choices[0].delta.content) {
	                completeContent += jsonData.choices[0].delta.content;
	              }
	            }
	          } catch (e) {
	            console.log("解析流数据出错:", e, jsonStr);
	          }
	        }
	      }
	    }
	
	    return completeContent;
	  } catch (error) {
	    console.log("AI生成内容错误:", error);
	    alert("AI生成内容失败：" + error.message);
	    return "";
	  }
	}


      async function sendEmail(subject, content, receiver) {
        console.log("开始发送邮件：", receiver);
        const htmlContent = `<div style="font-family: Arial, sans-serif; line-height:1.6;">${content.replace(/\n/g, '<br>')}</div>`;
        const templateParams = {
          to_email: receiver,
          subject: subject,
          message: htmlContent
        };
        try {
          const resp = await emailjs.send("service_x4a4ydu", "template_2451q64", templateParams);
          console.log("邮件发送成功：", resp.text);
        } catch (err) {
          console.log("邮件发送失败：", err);
          alert("邮件发送失败：" + err);
        }
      }

      function loadTaskFromStorage() {
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return null;
        try { return JSON.parse(raw); } 
        catch(e) { console.warn("加载本地任务错误:", e); return null; }
      }
      function saveTaskToStorage(task) {
        localStorage.setItem(LS_KEY, JSON.stringify(task));
      }
      function clearTaskInStorage() {
        localStorage.removeItem(LS_KEY);
      }

      window.addEventListener('load', () => {
        const savedTask = loadTaskFromStorage();
        if(!savedTask) {
          console.log("本地无未完成任务。");
          return;
        }
        console.log("检测到本地任务:", savedTask);
        currentTask = savedTask;
        promptConfigured = true;
        promptBtn.classList.add('configured');

        openModal(sendModal, false);
        sendOptionsSelect.style.display = 'none';
        scheduleContainer.classList.remove('active');
        successContainer.classList.remove('active');
        countdownContainer.classList.add('active');

        if(currentTask.mode === 'immediate') {
          resumeImmediateCountdown(currentTask);
        } else {
          resumeScheduledCountdown(currentTask);
        }
      });

      function resumeImmediateCountdown(task) {
        const now = Date.now();
        const diff = Math.floor((task.endTime - now)/1000);
        if(diff <= 0) {
          doSendEmail(true);
        } else {
          countdownInfo.textContent = "即将发送...";
          startCountdown(diff, true);
        }
      }
      function resumeScheduledCountdown(task) {
        const now = Date.now();
        const diff = Math.floor((task.endTime - now)/1000);
        if(diff <= 0) {
          doSendEmail(false);
        } else {
          const futureDate = new Date(task.endTime);
          countdownInfo.textContent = `将于 ${futureDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})} 发送`;
          startTimeCountdown(diff);
        }
      }

      function resetSendModal() {
        if (countdownInterval) clearInterval(countdownInterval);
        sendOptionsSelect.style.display = 'flex';
        scheduleContainer.classList.remove('active');
        countdownContainer.classList.remove('active');
        successContainer.classList.remove('active');
        timerDisplay.textContent = '10';
        circleProgress.style.strokeDashoffset = '0';
        countdownInfo.textContent = "正在等待发送...";
        scheduleTimeInput.value = '08:00';
        repeatOptionSelect.value = 'none';
      }
    });
  </script>
</body>
</html>
